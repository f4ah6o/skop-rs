name: Rust

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  CARGO_TERM_COLOR: always

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
    - uses: actions/checkout@v4

    - name: Set up Rust
      uses: dtolnay/rust-toolchain@stable

    - uses: swatinem/rust-cache@v2

    - uses: rust-lang/crates-io-auth-action@v1
      id: auth
      
    # === 追加: バージョンチェックのロジック ===
    - name: Check if version already exists
      id: check
      shell: bash
      run: |
        # cargo metadata からパッケージ名とバージョンを取得
        METADATA=$(cargo metadata --no-deps --format-version 1)
        NAME=$(echo "$METADATA" | jq -r '.packages[0].name')
        VERSION=$(echo "$METADATA" | jq -r '.packages[0].version')
        
        echo "Checking $NAME version $VERSION on crates.io..."
        
        # crates.io APIを叩いてステータスコードを取得 (200なら存在、404なら未存在)
        HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://crates.io/api/v1/crates/$NAME/$VERSION")
        
        if [ "$HTTP_STATUS" == "200" ]; then
          echo "Version $VERSION already exists. Skipping publish."
          echo "should_publish=false" >> $GITHUB_OUTPUT
        else
          echo "Version $VERSION not found. Proceeding to publish."
          echo "should_publish=true" >> $GITHUB_OUTPUT
        fi

    - run: cargo test --verbose

    - name: Publish
      # バージョンが新しく、かつ Pushイベントの時のみ実行 (PRでの事故防止)
      if: steps.check.outputs.should_publish == 'true' && github.event_name == 'push'
      run: cargo publish
      env:
        CARGO_REGISTRY_TOKEN: ${{ steps.auth.outputs.token }}
