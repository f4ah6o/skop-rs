name: Rust

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  CARGO_TERM_COLOR: always

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
    - uses: actions/checkout@v4

    - name: Set up Rust
      uses: dtolnay/rust-toolchain@stable

    - uses: swatinem/rust-cache@v2

    - uses: rust-lang/crates-io-auth-action@v1
      id: auth

    # === 修正: cargo search を使った判定ロジック ===
    - name: Check version with cargo search
      id: check
      shell: bash
      run: |
        # 1. Cargo.toml からローカルのパッケージ名とバージョンを取得 (簡易grep)
        # ※ ワークスペース構成などの場合はパス調整が必要ですが、単一クレートならこれでOK
        NAME=$(grep -m1 '^name =' Cargo.toml | cut -d '"' -f 2)
        VERSION=$(grep -m1 '^version =' Cargo.toml | cut -d '"' -f 2)
        
        echo "Checking logic for: $NAME = \"$VERSION\""

        # 2. cargo search で検索し、現在のバージョンが既に公開されているか確認
        # 重要: 色コードが入るとgrepが失敗するため、ここだけ color=never にする
        SEARCH_RESULT=$(CARGO_TERM_COLOR=never cargo search "$NAME" --limit 1)
        
        # 3. 出力行の中に 'package_name = "version"' が完全に一致するものがあるか判定
        if echo "$SEARCH_RESULT" | grep -q "^$NAME = \"$VERSION\""; then
          echo "::notice::Version $VERSION is already published on crates.io. Skipping."
          echo "should_publish=false" >> $GITHUB_OUTPUT
        else
          echo "::notice::Version $VERSION not found on crates.io (or implies update). Ready to publish."
          echo "should_publish=true" >> $GITHUB_OUTPUT
        fi

    # テストは常に実行（公開済みでも動作確認のため）
    - run: cargo test --verbose

    - name: Publish
      # チェックが true (未公開) かつ Pushイベントの時のみ実行
      if: steps.check.outputs.should_publish == 'true' && github.event_name == 'push'
      run: cargo publish
      env:
        CARGO_REGISTRY_TOKEN: ${{ steps.auth.outputs.token }}
